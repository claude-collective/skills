# Better Auth - v1.4+ Features

> New patterns and features introduced in Better Auth v1.4. See [SKILL.md](../SKILL.md) for core concepts.

**Additional Examples:**
- [core.md](core.md) - Sign up, sign in, client setup
- [oauth.md](oauth.md) - OAuth providers, Generic OAuth
- [sessions.md](sessions.md) - Session configuration
- [two-factor.md](two-factor.md) - TOTP setup
- [organizations.md](organizations.md) - Multi-tenancy

---

## Stateless Authentication (v1.4+)

Better Auth v1.4+ supports fully stateless session management without a database. Sessions are stored entirely in signed/encrypted cookies.

### Constants

```typescript
const CACHE_MAX_AGE_SECONDS = 60 * 5; // 5 minutes
const STATELESS_REFRESH_THRESHOLD = 0.8; // Refresh at 80% of maxAge
```

### Full Stateless (No Database)

```typescript
// lib/auth.ts
import { betterAuth } from "better-auth";

const CACHE_MAX_AGE_SECONDS = 60 * 5;

// Omit database option entirely for full stateless
export const auth = betterAuth({
  // No database option = stateless mode
  emailAndPassword: { enabled: true },
  session: {
    cookieCache: {
      enabled: true,
      maxAge: CACHE_MAX_AGE_SECONDS,
      strategy: "jwe", // Encrypted (most secure)
      refreshCache: true, // Auto-refresh before expiry
    },
  },
});

export { auth };
```

**Why good:** No database dependency, works with edge functions, automatic cookie refresh prevents expiration during active sessions

### Cookie Cache Strategies

```typescript
// Strategy comparison
session: {
  cookieCache: {
    enabled: true,
    maxAge: CACHE_MAX_AGE_SECONDS,
    // Choose ONE strategy:
    strategy: "compact", // Base64url + HMAC-SHA256 (smallest, fastest, internal use)
    strategy: "jwt",     // Standard JWT (readable, third-party verifiable)
    strategy: "jwe",     // Encrypted A256CBC-HS512 (largest, most secure)
  },
}
```

**When to use each:**
- `compact`: Internal apps, performance-critical (smallest payload)
- `jwt`: Need external verification, API consumers
- `jwe`: Sensitive session data, hide from client

---

## Experimental Database Joins (v1.4+)

Enable 2-3x faster database queries by optimizing over 50 endpoints with JOINs.

```typescript
// lib/auth.ts
import { betterAuth } from "better-auth";
import { drizzleAdapter } from "better-auth/adapters/drizzle";

import { db } from "@/lib/db";

export const auth = betterAuth({
  database: drizzleAdapter(db, { provider: "pg" }),
  // Enable experimental joins for 2-3x faster queries
  experimental: {
    joins: true,
  },
});

export { auth };
```

**Why good:** Significant performance improvement, single-query session lookups instead of multiple round trips

---

## Generic OAuth Plugin (v1.4+)

Use any OAuth 2.0 or OIDC provider with the Generic OAuth plugin.

### Server Configuration

```typescript
// lib/auth.ts
import { betterAuth } from "better-auth";
import { genericOAuth } from "better-auth/plugins";
import { drizzleAdapter } from "better-auth/adapters/drizzle";

import { db } from "@/lib/db";

export const auth = betterAuth({
  database: drizzleAdapter(db, { provider: "pg" }),
  plugins: [
    genericOAuth({
      config: [
        {
          providerId: "custom-idp",
          // Use discovery for OIDC providers
          discoveryUrl: "https://idp.example.com/.well-known/openid-configuration",
          clientId: process.env.CUSTOM_IDP_CLIENT_ID!,
          clientSecret: process.env.CUSTOM_IDP_CLIENT_SECRET!,
          scopes: ["openid", "email", "profile"],
          pkce: true, // Enhanced security
          // Optional: Map provider profile to user schema
          mapProfileToUser: (profile) => ({
            name: profile.name,
            email: profile.email,
            image: profile.picture,
          }),
        },
        // Pre-configured provider helpers available:
        // auth0({ clientId, clientSecret, domain })
        // keycloak({ clientId, clientSecret, issuer })
        // okta({ clientId, clientSecret, issuer })
        // microsoftEntraId({ clientId, clientSecret, tenantId })
        // slack({ clientId, clientSecret })
        // patreon({ clientId, clientSecret })
      ],
    }),
  ],
});

export { auth };
```

### Client-Side Generic OAuth

```typescript
// components/generic-oauth-button.tsx
import { authClient } from "@/lib/auth-client";

export function CustomIdpButton() {
  const handleSignIn = async () => {
    await authClient.signIn.oauth2({
      providerId: "custom-idp",
      callbackURL: "/dashboard",
    });
  };

  return (
    <button onClick={handleSignIn} type="button">
      Sign in with Custom IDP
    </button>
  );
}

export { CustomIdpButton };
```

**Why good:** Works with any OAuth2/OIDC provider, PKCE support for enhanced security, pre-configured helpers for common providers

---

## useSession with Refetch (v1.4.12+)

The `useSession` hook now includes a `refetch` method for manual session refresh.

```typescript
// components/session-refresh.tsx
import { authClient } from "@/lib/auth-client";

export function SessionStatus() {
  const { data: session, isPending, error, refetch } = authClient.useSession();

  const handleRefresh = async () => {
    // Manual session refresh
    await refetch();
  };

  if (isPending) return <div>Loading...</div>;
  if (!session?.user) return <div>Not signed in</div>;

  return (
    <div>
      <span>{session.user.email}</span>
      <button onClick={handleRefresh} type="button">
        Refresh Session
      </button>
    </div>
  );
}

export { SessionStatus };
```

**Why good:** Manual control over session refresh, useful for polling or after sensitive operations

---

## Password Reset (v1.4+ API)

The `forgotPassword` method was renamed to `requestPasswordReset` in v1.4.

```typescript
// hooks/use-password-reset.ts
import { useState } from "react";

import { authClient } from "@/lib/auth-client";

export function usePasswordReset() {
  const [isPending, setIsPending] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState(false);

  const requestReset = async (email: string) => {
    setIsPending(true);
    setError(null);
    setSuccess(false);

    try {
      // v1.4+: Use requestPasswordReset (not forgotPassword)
      const result = await authClient.requestPasswordReset({
        email,
        redirectTo: "/auth/reset-password",
      });

      if (result.error) {
        setError(result.error.message);
        return { success: false };
      }

      setSuccess(true);
      return { success: true };
    } catch (err) {
      setError("Failed to send reset email");
      return { success: false };
    } finally {
      setIsPending(false);
    }
  };

  return { requestReset, isPending, error, success };
}

// Named export
export { usePasswordReset };
```

**Why good:** Clearer method name, consistent with action-based naming

---

## OAuth Provider Plugin (v1.4+)

Act as an OAuth 2.1 provider for other services (replaces deprecated oidcProvider).

```typescript
// lib/auth.ts
import { betterAuth } from "better-auth";
import { oAuthProvider } from "better-auth/plugins";
import { drizzleAdapter } from "better-auth/adapters/drizzle";

import { db } from "@/lib/db";

export const auth = betterAuth({
  database: drizzleAdapter(db, { provider: "pg" }),
  plugins: [
    oAuthProvider({
      clients: [
        {
          clientId: "my-first-party-app",
          clientSecret: process.env.FIRST_PARTY_CLIENT_SECRET!,
          redirectUris: ["https://app.example.com/callback"],
          // Trusted clients skip consent screen
          skipConsent: true,
        },
        {
          clientId: "third-party-integration",
          clientSecret: process.env.THIRD_PARTY_CLIENT_SECRET!,
          redirectUris: ["https://partner.example.com/oauth/callback"],
          skipConsent: false, // Show consent screen
        },
      ],
    }),
  ],
});

export { auth };
```

**Why good:** OAuth 2.1 compliant, trusted client support for first-party apps, consent screen control

---

## Bundle Size Optimization

Use `better-auth/minimal` to reduce bundle size when using custom adapters.

```typescript
// lib/auth.ts
// Use minimal version when using Prisma, Drizzle, or MongoDB adapters
import { betterAuth } from "better-auth/minimal";
import { drizzleAdapter } from "better-auth/adapters/drizzle";

import { db } from "@/lib/db";

export const auth = betterAuth({
  database: drizzleAdapter(db, { provider: "pg" }),
  // ... config
});

export { auth };
```

**Why good:** Excludes Kysely (only needed for direct DB connections), smaller bundle for serverless

**When to use:** Projects using Prisma, Drizzle, or MongoDB adapters (NOT direct database connections)

---

## verifyPassword API (v1.4.11+)

Server-side password verification for sensitive operations.

```typescript
// routes/settings.ts
import { auth } from "@/lib/auth";

const HTTP_STATUS_UNAUTHORIZED = 401;
const HTTP_STATUS_OK = 200;

app.post("/settings/change-email", async (c) => {
  const session = c.get("session");
  const { password, newEmail } = await c.req.json();

  // Verify current password before sensitive operation
  const isValid = await auth.api.verifyPassword({
    body: {
      email: session.user.email,
      password,
    },
  });

  if (!isValid) {
    return c.json({ error: "Invalid password" }, HTTP_STATUS_UNAUTHORIZED);
  }

  // Proceed with email change...
  return c.json({ success: true }, HTTP_STATUS_OK);
});

export { app };
```

**Why good:** Server-side password verification, useful for confirming identity before sensitive operations
